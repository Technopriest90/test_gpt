<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="ru">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <link href="http://sng-forweb-dev:8109/fp9.x/build/PP.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="http://sng-forweb-dev:8109/fp9.x/build/PP.js"></script>
    <script type="text/javascript" src="http://sng-forweb-dev:8109/fp9.x/build/PP.Metabase.js"></script>
    <script type="text/javascript" src="http://sng-forweb-dev:8109/fp9.x/build/PP.Navigator.js"></script>
    <script type="text/javascript" src="http://sng-forweb-dev:8109/fp9.x/build/PP.Report.js"></script>
    <script type="text/javascript" src="http://sng-forweb-dev:8109/fp9.x/build/PP.App.js"></script>
    <script type="text/javascript" src="http://sng-forweb-dev:8109/fp9.x/resources/PP.resources.ru.js"></script>
    <script type="text/javascript">
        var styles = ["http://sng-forweb-dev:8109/fp9.x/build/PP.css",
            "http://sng-forweb-dev:8109/fp9.x/build/PP.App.css",
            "http://sng-forweb-dev:8109/fp9.x/build/PP.Metabase.css",
            "http://sng-forweb-dev:8109/fp9.x/build/PP.Navigator.css",
            "http://sng-forweb-dev:8109/fp9.x/build/PP.Report.css"
        ];
        if (PP.IsIE) {
            PP.scriptManager.loadStyles([styles[0]]);
            styles.shift();
        }
        PP.scriptManager.loadStyles(styles);
    </script>
</head>
<script defer type="text/javascript">
    var metabase, prxReport, prxMbService, dataArea;

    function renderReport() {
        const urlSearchParams = new URLSearchParams(window.location.search);
        const params = Object.fromEntries(urlSearchParams.entries());
        if (params.OBJ || params.ID) {
            PP.ImagePath = "http://sng-forweb-dev:8109/fp9.x/build/img/";
            PP.ScriptPath = "http://sng-forweb-dev:8109/fp9.x/build/"; // путь до сборок
            PP.CSSPath = "http://sng-forweb-dev:8109/fp9.x/build/";
            PP.resourceManager.setRootResourcesFolder(
                "http://sng-forweb-dev:8109/fp9.x/resources/"); //путь до папки с ресурсами
            PP.resourceManager.setResourceList(['PP', 'Metabase', 'Regular', 'VisualizerMaster']);
            PP.setCurrentCulture(PP.Cultures.ru); //языковые настройки для ресурсов
            var waiter = new PP.Ui.Waiter();
            metabase = new PP.Mb.Metabase( //создаем соединение с метабазой
                {
                    PPServiceUrl: "./service.jsp",
                    Id: "SNG_METABASE",
                    UserCreds: {
                        UserName: "TEST",
                        Password: "TEST"
                    },
                    //в начале запроса к метабазе отображается компонент Waiter
                    StartRequest: function () {
                        waiter.show();
                    },
                    //при окончании запроса к метабазе компонент Waiter скрывается
                    EndRequest: function (sender, args) {
                        waiter.hide();
                        if (args.Response && args.Response.OpenMetabaseResult) {
                            localStorage.setItem('fs-moniker', JSON.stringify({
                                id: metabase.getConnectionOdId().id,
                                time: new Date().getTime()
                            }))
                            console.log("НОВАЯ СЕССИЯ: " + metabase.getConnectionOdId().id + " от " +
                                new Date());
                        }
                        //при окончании выполнения запроса все запросы удаляются из кэша
                        metabase.clearCache();
                    },
                    //при ошибке на экране появится сообщение с текстом ошибки
                    Error: function (sender, args) {
                        alert(args.ResponseText);
                    }
                });
            // Сохраняю моникер в localStorage
            if (localStorage.getItem('fs-moniker')) {
                let oObj = null;
                try {
                    let oTemp = JSON.parse(localStorage.getItem('fs-moniker'));
                    if ((new Date().getTime() - oTemp.time) <= 500000) oObj = oTemp;
                } catch (e) { }
                if (oObj) {
                    metabase._ConnectionOdId.id = oObj.id;
                    metabase.refresh();
                    console.log("СТАРАЯ СЕССИЯ: " + oObj.id + " от " + new Date(oObj.time));
                } else {
                    metabase.open();
                }
            } else {
                metabase.open();
            }


            //открываем метабазу
            metabase.findObjects(113427, {}, function (sender, args) {
                var loadedObjects = JSON.parse(args.ResponseText).GetObjectsResult.mds.its.it;
                let oPrx;
                loadedObjects.find(el => {
                    const {
                        obInst,
                        pars
                    } = el;
                    const {
                        c: iClassId,
                        i: sObjId,
                        k: iId
                    } = obInst.obDesc;
                    let bOut = iClassId === 2562 &&
                        (!params.OBJ || (params.OBJ && sObjId == params.OBJ)) &&
                        (!params.ID || (params.ID && iId == params.ID));
                    if (bOut) {
                        let aParams = [];
                        if (!!pars) {
                            let getValue = ({ id, type }) => {
                                switch(type) {
                                    case 2:
                                        return +params[id];
                                    default:
                                        return params[id];
                                }
                            };
                            aParams = pars.it.map(({
                                binding,
                                dt,
                                id,
                                k,
                                n,
                                vis
                            }) => {
                                return new PP.Mb.Param({
                                    Id: id, // Идентификатор параметра
                                    Key: k, // Ключ
                                    Name: n, // Наименование параметра
                                    Type: dt,
                                    Value: getValue({ id, type: dt }),
                                    Visible: vis
                                })
                            })
                        }
                        oPrx = {
                            iClassId,
                            sObjId,
                            iId,
                            aParams
                        }
                    }
                });
                console.log(oPrx);
                if (oPrx) {
                    prxMbService = new PP.Prx.PrxMdService({
                        Metabase: metabase
                    }); //создаем сервис для работы с регламентными отчетами
                    prxReport = prxMbService.openReport(oPrx.iId, oPrx.aParams, false); //открываем отчет из метабазы по ключу
                    //получаем массив параметров
                    dataArea = new PP.Prx.Ui.DataArea({
                        ParentNode: "dataArea",
                        Source: prxReport, //указываем отчет-источник
                        Service: prxMbService
                    });
                    window.onresize();
                } else {
                    alert("Отсутствует отчет с такими параметрами")
                }
            })

            //var pdfExpDialog = new PP.Prx.Ui.PdfExportDialog();
            // var xlsExpDialog = new PP.Prx.Ui.XlsExportDialog();
            // xlsExpDialog.OkButtonClicked.add(function (sender, {
            //     exportData
            // }) {
            //     exportData.format = "xls";
            //     prxMbService.Export(prxReport, exportData, res => {
            //         try {
            //             let oResponse = JSON.parse(res._ResponseText);
            //             let oPrxMdResult = !!oResponse.GetPrxMdResult ? oResponse.GetPrxMdResult : oResponse.BatchExecResult.its.it[1].GetPrxMdResult
            //             let sId = oPrxMdResult.meta.exportData.storeId.id;
            //             let url = `./serviceExcel.jsp?id=${sId}`;
            //             const anchor = document.createElement('a');
            //             anchor.href = url;
            //             anchor.download = "TEST.xls";

            //             // Append to the DOM
            //             document.body.appendChild(anchor);

            //             // Trigger `click` event
            //             anchor.click();

            //             // Remove element from DOM
            //             document.body.removeChild(anchor);

            //             //let url = "http://sng-forweb-dev:8109/fp9.x/app/PPService.axd?action=export&key=" + sId + "&format=xls&d=1342526431868&inline=false";
            //             //let url = "http://sng-forweb-dev:8109/fp9.x/app/PPService.axd/GetBin?mon=" + sId + "&fileName=13.7.xls&attach=1";
            //             // fetch(url)
            //             //     .then(response => {
            //             //         return response.arrayBuffer();
            //             //     })
            //             //     .then(text => {
            //             //         function s2ab(buf) {
            //             //             let view = new Uint8Array(buf);
            //             //             for (let i = 0; i != s.length; ++i) {
            //             //                 view[i] = s.charCodeAt(i) & 0xFF;
            //             //             }
            //             //             return buf;
            //             //         }
            //             //         /*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
            //             //         var saveAs = saveAs || function (e) { "use strict"; if (typeof e === "undefined" || typeof navigator !== "undefined" && /MSIE [1-9]\./.test(navigator.userAgent)) { return } var t = e.document, n = function () { return e.URL || e.webkitURL || e }, r = t.createElementNS("http://www.w3.org/1999/xhtml", "a"), o = "download" in r, a = function (e) { var t = new MouseEvent("click"); e.dispatchEvent(t) }, i = /constructor/i.test(e.HTMLElement) || e.safari, f = /CriOS\/[\d]+/.test(navigator.userAgent), u = function (t) { (e.setImmediate || e.setTimeout)(function () { throw t }, 0) }, s = "application/octet-stream", d = 1e3 * 40, c = function (e) { var t = function () { if (typeof e === "string") { n().revokeObjectURL(e) } else { e.remove() } }; setTimeout(t, d) }, l = function (e, t, n) { t = [].concat(t); var r = t.length; while (r--) { var o = e["on" + t[r]]; if (typeof o === "function") { try { o.call(e, n || e) } catch (a) { u(a) } } } }, p = function (e) { if (/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)) { return new Blob([String.fromCharCode(65279), e], { type: e.type }) } return e }, v = function (t, u, d) { if (!d) { t = p(t) } var v = this, w = t.type, m = w === s, y, h = function () { l(v, "writestart progress write writeend".split(" ")) }, S = function () { if ((f || m && i) && e.FileReader) { var r = new FileReader; r.onloadend = function () { var t = f ? r.result : r.result.replace(/^data:[^;]*;/, "data:attachment/file;"); var n = e.open(t, "_blank"); if (!n) e.location.href = t; t = undefined; v.readyState = v.DONE; h() }; r.readAsDataURL(t); v.readyState = v.INIT; return } if (!y) { y = n().createObjectURL(t) } if (m) { e.location.href = y } else { var o = e.open(y, "_blank"); if (!o) { e.location.href = y } } v.readyState = v.DONE; h(); c(y) }; v.readyState = v.INIT; if (o) { y = n().createObjectURL(t); setTimeout(function () { r.href = y; r.download = u; a(r); h(); c(y); v.readyState = v.DONE }); return } S() }, w = v.prototype, m = function (e, t, n) { return new v(e, t || e.name || "download", n) }; if (typeof navigator !== "undefined" && navigator.msSaveOrOpenBlob) { return function (e, t, n) { t = t || e.name || "download"; if (!n) { e = p(e) } return navigator.msSaveOrOpenBlob(e, t) } } w.abort = function () { }; w.readyState = w.INIT = 0; w.WRITING = 1; w.DONE = 2; w.error = w.onwritestart = w.onprogress = w.onwrite = w.onabort = w.onerror = w.onwriteend = null; return m }(typeof self !== "undefined" && self || typeof window !== "undefined" && window || this.content); if (typeof module !== "undefined" && module.exports) { module.exports.saveAs = saveAs } else if (typeof define !== "undefined" && define !== null && define.amd !== null) { define("FileSaver.js", function () { return saveAs }) }

            //             //         saveAs(new Blob([text], {
            //             //             type: "application/octet-stream"
            //             //         }), "test.xls");
            //             //     }).catch(function (err) {
            //             //         console.log('Fetch Error :-S', err);
            //             //     });
            //             console.log(sId);
            //             // TODO: Метод возвращает ID документа, который нужно передать в PPService.axd
            //             // 

            //         } catch (e) {
            //             console.error(e);
            //         }
            //     })
            // });
            // pdfExpDialog.OkButtonClicked.add(function (sender, {
            //     exportData
            // }) {
            //     exportData.format = "pdf";
            //     prxMbService.Export(prxReport, exportData, res => {
            //         try {
            //             let oResponse = JSON.parse(res._ResponseText);
            //             let oPrxMdResult = !!oResponse.GetPrxMdResult ? oResponse.GetPrxMdResult : oResponse
            //                 .BatchExecResult.its.it[1].GetPrxMdResult
            //             let sId = oPrxMdResult.meta.exportData.storeId.id;
            //             let url = `./serviceExcel.jsp?id=${sId}`;
            //             const anchor = document.createElement('a');
            //             anchor.href = url;
            //             anchor.download = "TEST.pdf";

            //             // Append to the DOM
            //             document.body.appendChild(anchor);

            //             // Trigger `click` event
            //             anchor.click();

            //             // Remove element from DOM
            //             document.body.removeChild(anchor);
            //             console.log(sId);
            //             // TODO: Метод возвращает ID документа, который нужно передать в PPService.axd
            //             //
            //         } catch (e) {
            //             console.error(e);
            //         }
            //     })
            // });

            function exportXls() {
                let exportData = {
                    "format": "xls",
                    "storeResult": true,
                    "reportTitle": false,
                    "sheetTitles": false,
                    "showWarnings": true,
                    "pagesKeysRange": "",
                    "hiddenCells": true,
                    "hiddenSheets": false,
                    "chartsAsImages": false,
                    "sheetAccess": false,
                    "formulas": true,
                    "exportExpanders": false
                };
                prxMbService.Export(prxReport, exportData, res => {
                    try {
                        let oResponse = JSON.parse(res._ResponseText);
                        let oPrxMdResult = !!oResponse.GetPrxMdResult ? oResponse.GetPrxMdResult : oResponse
                            .BatchExecResult.its.it[1].GetPrxMdResult
                        let sId = oPrxMdResult.meta.exportData.storeId.id;
                        //let url = `./serviceExcel.jsp?id=${sId}`;
                        let url = `http://sng-forweb-dev:8109/fp9.x/app/PPService.axd/GetBin?mon=${sId}&fileName=13.7.xls&attach=1`;
                        const anchor = document.createElement('a');
                        anchor.href = url;
                        anchor.download = "TEST.xls";

                        // Append to the DOM
                        document.body.appendChild(anchor);

                        // Trigger `click` event
                        anchor.click();

                        // Remove element from DOM
                        document.body.removeChild(anchor);
                        console.log(sId);
                        // TODO: Метод возвращает ID документа, который нужно передать в PPService.axd
                        // 

                    } catch (e) {
                        console.error(e);
                    }
                })
            }

            function exportPdf() {
                let exportData = {
                    "format": "pdf",
                    "storeResult": true,
                    "reportTitle": false,
                    "sheetTitles": false,
                    "showWarnings": true,
                    "pagesKeysRange": ""
                };
                prxMbService.Export(prxReport, exportData, res => {
                    try {
                        let oResponse = JSON.parse(res._ResponseText);
                        let oPrxMdResult = !!oResponse.GetPrxMdResult ? oResponse.GetPrxMdResult : oResponse
                            .BatchExecResult.its.it[1].GetPrxMdResult
                        let sId = oPrxMdResult.meta.exportData.storeId.id;
                        //let url = `./serviceExcel.jsp?id=${sId}`;
                        let url = `http://sng-forweb-dev:8109/fp9.x/app/PPService.axd/GetBin?mon=${sId}&fileName=13.7.pdf&attach=1`;
                        const anchor = document.createElement('a');
                        anchor.href = url;
                        anchor.download = "TEST.pdf";

                        // Append to the DOM
                        document.body.appendChild(anchor);

                        // Trigger `click` event
                        anchor.click();

                        // Remove element from DOM
                        document.body.removeChild(anchor);
                        console.log(sId);
                        // TODO: Метод возвращает ID документа, который нужно передать в PPService.axd
                        //
                    } catch (e) {
                        console.error(e);
                    }
                })
            }
            var btnXls = new PP.Ui.Button({
                ParentNode: document.getElementById("btn1"),
                Click: exportXls,
                Content: "Экспорт в Excel"
            })
            var btnPdf = new PP.Ui.Button({
                ParentNode: document.getElementById("btn2"),
                Click: exportPdf,
                Content: "Экспорт в PDF"
            })
            window.onresize();
        } else {
            alert("Отсутствует обязательный параметр: ID или OBJ");
        }
    }
    var idTime;
    //функция для изменения размера компонента при изменении размера контейнера
    window.onresize = function updateSize() {
        if (idTime)
            clearTimeout(idTime);
        idTime = setTimeout(function () {
            if (dataArea) {
                let oDataArea = document.getElementById("dataArea");
                oDataArea.style["height"] = `${window.innerHeight - 23}px`;
                dataArea.setSize(oDataArea.offsetWidth - 2, window.innerHeight - 23);
            }
            idTime = null;
        }, 50);
    };
</script>

<body onselectstart="return false" onload="renderReport()" style="height: 100%;">
    <div style="display: flex;">
        <div id="btn1"></div>
        <div id="btn2"></div>
    </div>

    <div id="dataArea" style="height: 800px;">

    </div>

</body>

</html>